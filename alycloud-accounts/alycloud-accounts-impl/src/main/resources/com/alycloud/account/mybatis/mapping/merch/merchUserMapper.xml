<?xml version="1.0" encoding="GBK" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="com.alycloud.account.mapper.MerchUserMapper">
	<!-- add by Horanluo start -->
	<resultMap id="merchUserResultMap" type="MerchUser">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 19 16:46:49 GMT+08:00 2017.
    -->
	    <id column="id" jdbcType="INTEGER" property="id" />
	    <result column="user_roler" jdbcType="INTEGER" property="userRoler" />
	    <result column="merch_id" jdbcType="INTEGER" property="merchId" />
	    <result column="login_name" jdbcType="VARCHAR" property="loginName" />
	    <result column="true_name" jdbcType="VARCHAR" property="trueName" />
	    <result column="password" jdbcType="VARCHAR" property="password" />
	    <result column="telephone" jdbcType="VARCHAR" property="telephone" />
	    <result column="mobile" jdbcType="VARCHAR" property="mobile" />
	    <result column="email" jdbcType="VARCHAR" property="email" />
	    <result column="address" jdbcType="VARCHAR" property="address" />
	    <result column="status" jdbcType="INTEGER" property="status" />
	    <result column="last_login" jdbcType="VARCHAR" property="lastLogin" />
	    <result column="login_error_date" jdbcType="VARCHAR" property="loginErrorDate" />
	    <result column="error_count" jdbcType="INTEGER" property="errorCount" />
	    <result column="branchno" jdbcType="VARCHAR" property="branchno" />
	    <result column="head_index" jdbcType="INTEGER" property="headIndex" />
	    <result column="open_id" jdbcType="VARCHAR" property="openId" />
	    <result column="refer_name" jdbcType="VARCHAR" property="referName" />
	    <result column="user_rank" jdbcType="INTEGER" property="userRank" />
	    <result column="mobile" jdbcType="VARCHAR" property="merchMobile" />
	    <result column="agentno" jdbcType="VARCHAR" property="agentno" />
  	</resultMap>
  	
  	<sql id="Merch_User_Column_List">
	    <!--
	      WARNING - @mbg.generated
	      This element is automatically generated by MyBatis Generator, do not modify.
	      This element was generated on Thu Oct 19 16:46:49 GMT+08:00 2017.
	    -->
	    id, user_roler, merch_id, login_name, true_name, password, telephone, mobile, email, 
	    address, status, last_login, login_error_date, error_count, branchno, head_index, 
	    open_id, refer_name,user_rank
  	</sql>
  	<!-- add by Horanluo end -->
  	
	<!--  
		数据库中的表名
	-->
	<sql id="tableName">
		merch_user
	</sql>
	<!--  
		分页查询的条件
	-->
	<sql id="queryCondtion">
	     <trim prefix="where" prefixOverrides="and |or">
		     <if test="loginName !=null">
		         and login_name = #{loginName}
		     </if>
		     <if test="mobile !=null">
		         and mobile = #{mobile}
		     </if>
		     <if test="branchno !=null">
		         and branchno = #{branchno}
		     </if>
		     <if test="merchId !=null">
		         and merch_id = #{merchId}
		     </if>
		     <if test="referName !=null">
		         and refer_name = #{referName}
		     </if>
	     </trim>
	</sql>
	
	<!--  
		字段映射关系
	-->
	<sql id="fieldMapping">
   		id 				 as id,
   		user_roler 		 as userRoler,
   		branchno 		 as branchno,
   		merch_id 		 as merchId,
   		login_name 		 as loginName,
   		true_name 		 as trueName,
   		password 		 as password,
   		mobile 			 as mobile,
   		open_id 		 as openId,
   		address			 as address,
   		error_count 	 as errorCount,
   		head_index 		 as headIndex,		
   		last_login		 as lastLogin,
   		login_error_date as loginErrorDate,
   		status 			 as status,
   		user_rank		 as userRank
	</sql> 
	
	
	<!--  
		更新字段
	-->
	<sql id="updateField">
	     <trim prefix="set" prefixOverrides=",">
		     <if test="userRank !=null">
		         , user_rank = #{userRank}
		     </if>
		 </trim>
	</sql>
	
	<!-- 
		添加记录 
	-->
    <insert 
    	id="add"
    	parameterType="MerchUser"
    	useGeneratedKeys="true" 
    	keyProperty="id">
    	insert into <include refid="tableName"/>(
    		user_roler,branchno,merch_id,login_name,true_name,password,mobile,open_id
    	)values(
    		#{userRoler},#{branchno},#{merchId},#{loginName},#{trueName},#{password},#{mobile},#{openId}
    	)
    </insert>
    
    
    <!-- 
    	更新记录 
    -->
    <update 
		id="mod" 
		parameterType="MerchUser">
		update
			<include refid="tableName"/>
			<include refid="updateField"/>
		where
			id = #{id}
	</update>
	
    <!--  
    	分页查询信息
    -->
    <select 
    	id="listByPage"
    	parameterType="MerchUser4Search"
    	resultType="MerchUser">
    	select 
    		 <include refid="fieldMapping"/>
    	from 
    		<include refid="tableName"/>
    		<include refid="queryCondtion"/>
    	order by 
    		id desc
    	limit
    		${startIndex}, ${pageSize}
    </select>
    
    <!--  
    	查询记录数
    -->
    <select 
    	id="count"
    	parameterType="MerchUser4Search"
    	resultType="Integer">
    	select 
    		 count(*)
    	from 
    		<include refid="tableName"/>
    		<include refid="queryCondtion"/>
    </select>
    
    <select 
    	id="getById"
    	parameterType="Integer"
    	resultType="MerchUser">
    	select 
    		 <include refid="fieldMapping"/>
    	from 
    		<include refid="tableName"/>
    	where id=#{id}
    </select>
    
    <!-- 
    	按等级统计被邀请人数
     -->
    <select 
    	id="countGradeInviteeByUserId"
    	parameterType="Integer"
    	resultType="HashMap">
    	select 
			grade_type as gradeType,
			grade_name as gradeName,
			(select ifnull(sum(1),0) from merch_user where refer_name=#{userId} and user_rank=grade_type) as directCount,
			(select ifnull(sum(1),0) from merch_user u1 where u1.user_rank=grade_type and exists(select 1 from merch_user u2 where u1.refer_name=u2.id and u2.refer_name=#{userId})) as indirectCount
		from grade having directCount>0 or indirectCount>0;
    </select>
    <!-- 
    	统计被邀请人数
     -->
    <select 
    	id="countInviteeByUserId"
    	parameterType="Integer"
    	resultType="Integer">
    	select ifnull(sum(1),0) from merch_user u1 where 
    	u1.refer_name=#{userId} 
    	or 
    	exists(select 1 from merch_user u2 where u1.refer_name=u2.id and u2.refer_name=#{userId})
    	<!--select sum(tmpcount) from (
		select ifnull(sum(1),0) as tmpcount  from merch_user u1 where u1.refer_name=#{userId}
		UNION ALL
		select sum(1) as tmpcount from merch_user u2,merch_user u3 where u3.refer_name=u2.id and u2.refer_name=#{userId}) tmp-->
    </select>
    
    <!-- add by Horanluo start -->
    <select 
    	id="queryMerchUser"
    	parameterType="HashMap"
    	resultMap="merchUserResultMap">
		select 
			<include refid="Merch_User_Column_List" />
    	from 
    		merch_user
    	where 1=1
    		<if test="loginName != null">
        		and login_name = #{loginName,jdbcType=VARCHAR}
      		</if>
      		<if test="merchId != null">
        		and merch_id = #{merchId,jdbcType=VARCHAR}
      		</if>
      		<if test="id != null">
        		and id = #{id,jdbcType=VARCHAR}
      		</if>
    </select>
    
    <update 
    	 id="updateMerchUser"
    	 parameterType="HashMap">
    	 update merch_user
    	 set
    	 	status=#{status},
    	 	error_count=#{errorCount}+1
    		where id=#{id}
    </update>
    
    <insert 
    	 id="addMerchUser"
    	 parameterType="MerchUser">
    insert into merch_user (user_roler, merch_id, 
	      login_name, true_name, password, 
	      telephone, mobile, email, 
	      address, status, last_login, 
	      login_error_date, error_count, branchno, 
	      head_index, open_id, refer_name,user_rank
      )
    values (#{userRoler,jdbcType=INTEGER}, #{merchId,jdbcType=INTEGER}, 
      #{loginName,jdbcType=VARCHAR}, #{trueName,jdbcType=VARCHAR}, #{password,jdbcType=VARCHAR}, 
      #{telephone,jdbcType=VARCHAR}, #{mobile,jdbcType=VARCHAR}, #{email,jdbcType=VARCHAR}, 
      #{address,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER}, #{lastLogin,jdbcType=VARCHAR}, 
      #{loginErrorDate,jdbcType=VARCHAR}, #{errorCount,jdbcType=INTEGER}, #{branchno,jdbcType=VARCHAR}, 
      #{headIndex,jdbcType=INTEGER}, #{openId,jdbcType=VARCHAR}, #{referName,jdbcType=VARCHAR},#{userRank,jdbcType=INTEGER}
    )
    </insert>
    
  <update id="updateMerchUserInfo" parameterType="MerchUser">
    update merch_user
    <set>
      <if test="userRoler != null">
        user_roler = #{userRoler,jdbcType=INTEGER},
      </if>
      <if test="merchId != null">
        merch_id = #{merchId,jdbcType=INTEGER},
      </if>
      <if test="loginName != null">
        login_name = #{loginName,jdbcType=VARCHAR},
      </if>
      <if test="trueName != null">
        true_name = #{trueName,jdbcType=VARCHAR},
      </if>
      <if test="password != null">
        password = #{password,jdbcType=VARCHAR},
      </if>
      <if test="telephone != null">
        telephone = #{telephone,jdbcType=VARCHAR},
      </if>
      <if test="mobile != null">
        mobile = #{mobile,jdbcType=VARCHAR},
      </if>
      <if test="email != null">
        email = #{email,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        address = #{address,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="lastLogin != null">
        last_login = #{lastLogin,jdbcType=VARCHAR},
      </if>
      <if test="loginErrorDate != null">
        login_error_date = #{loginErrorDate,jdbcType=VARCHAR},
      </if>
      <if test="errorCount != null">
        error_count = #{errorCount,jdbcType=INTEGER},
      </if>
      <if test="branchno != null">
        branchno = #{branchno,jdbcType=VARCHAR},
      </if>
      <if test="headIndex != null">
        head_index = #{headIndex,jdbcType=INTEGER},
      </if>
      <if test="openId != null">
        open_id = #{openId,jdbcType=VARCHAR},
      </if>
      <if test="referName != null">
        refer_name = #{referName,jdbcType=VARCHAR},
      </if>
      <if test="userRank != null">
        user_rank = #{userRank,jdbcType=INTEGER},
      </if>
    </set>
    where
      <if test="id != null">
        id = #{id,jdbcType=INTEGER}
      </if>
  </update>
  
  <update 
   	 id="changeLoginName"
   	 parameterType="HashMap">
   	 update 
   	 	merch_user mu,merch_info mi
	set mu.login_name=#{newMobile,jdbcType=VARCHAR},mi.user_id=#{newMobile,jdbcType=VARCHAR} 
	where mu.merch_id=mi.id and mu.login_name=#{oldMobile,jdbcType=VARCHAR} and mi.user_id=#{oldMobile,jdbcType=VARCHAR}
  </update>
  
  <!-- 推荐人升级 -->
	<select id="getReferInfo" parameterType="String" resultMap="merchUserResultMap">
		select 
			u2.id, u2.user_roler, u2.merch_id, u2.login_name, u2.true_name, u2.password, u2.telephone, u2.mobile, u2.email, 
	    	u2.address, u2.status, u2.last_login, u2.login_error_date, u2.error_count, u2.branchno, u2.head_index, 
	    	u2.open_id, u2.refer_name,u2.user_rank 
		from merch_user u2 
		where u2.id =(select u1.refer_name from merch_user u1 left JOIN merch_info i on u1.merch_id=i.id where i.merchno=#{merchno,jdbcType=VARCHAR});
	</select>
	
	<select id="getReferInfoByMerchUser" parameterType="MerchUser" resultMap="merchUserResultMap">
		select 
			u2.id, u2.user_roler, u2.merch_id, u2.login_name, u2.true_name, u2.password, u2.telephone, u2.mobile, u2.email, 
	    	u2.address, u2.status, u2.last_login, u2.login_error_date, u2.error_count, u2.branchno, u2.head_index, 
	    	u2.open_id, u2.refer_name,u2.user_rank ,mi.mobile,ai.agentno
		from merch_user u1 
		left join merch_user u2 on u1.refer_name=u2.id
		left join merch_info mi on u2.merch_id=mi.id
		left join agent_info ai on mi.mobile=ai.mobile 
		where u1.id=#{id,jdbcType=VARCHAR}
	</select>
  <!-- add by Horanluo end -->
</mapper>